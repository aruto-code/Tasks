# Express Boilerplate Package

A production-ready Express.js boilerplate package that provides a pre-configured Express application with built-in security, logging, and best practices.

## Features

- Pre-configured Express application
- Built-in security middleware (helmet, xss-clean, hpp)
- Custom logging with Winston
- CORS configuration
- Built in monitoring
- custom async handling(wrapAsync)
- custom error handling
- Built-in router boilerplate

## Installation

```bash
npm install bitbucket:kimiajourney/express-boilerplate
```

## Quick Start

```javascript
const { createApp, logger } = require('express-boilerplate');

const app = createApp({
  routePrefix: '/api',
});
```

### Creating an App Instance

The `createApp` function accepts a configuration object with the following options:

```javascript
const middlewares = [
  //  helmet(),
  (req, res, next) => {
    req.requestId = Date.now().toString();
    next();
  },
];

const app = createApp({
  routes, // Your Express router instance
  corsOptions, // CORS configuration
  routePrefix: '/api', // Global route prefix (e.g., '/api')
  middlewares, // Array of custom middleware
});

const server = app.listen(config.port, () => {
  logger.info(`Listening to port ${config.port}`);
});
```

### Router and wrapAsync

Built-in router boilerplate and wrapAsync handler

```javascript
const { createRouter } = require('express-boilerplate');
const router = createRouter();
router.post('/api', controller);

router.get(
  '/',
  wrapAsync(async (req, res) => {
    res.status(201).json({ message: 'Hi' });
  })
);
```

### Logging

Built-in Winston logger for consistent logging:

```javascript
const { logger } = require('express-boilerplate');

logger.info('Server started', { port: 3000 });
logger.error('Database connection failed', { error });
logger.warn('High memory usage', { usage: process.memoryUsage() });
```

### Metrics

Built-in custom mertrics used to show both common metrics and custom metrics. Example given below

```javascript
const { getMetricsRegistry, promClient } = require('express-boilerplate');
const register = getMetricsRegistry();

const emailCounter = new promClient.Counter({
  name: 'email_service_processed_emails',
  help: 'Number of emails processed by the email service',
  labelNames: ['status'],
});

const emailDurationHistogram = new promClient.Histogram({
  name: 'email_service_processing_duration_seconds',
  help: 'Duration of email processing',
  labelNames: ['status'],
  buckets: [0.1, 0.5, 1, 2.5, 5, 10],
});

register.registerMetric(emailCounter);
register.registerMetric(emailDurationHistogram);

const processEmailMetrics = async (status, duration) => {
  emailCounter.inc({ status });
  emailDurationHistogram.observe(duration / 1000, { status }); // convert to seconds
};

module.exports = { processEmailMetrics };
```

Now import the metrics function in the desired file and use it as follows:

```javascript
const { processEmailMetrics } = require('./monitoring/metrics');

const sendEmail = async (email, otp) => {
  const start = Date.now();
  const subject = 'Read Me';
  const templateName = 'Hi this is the readme file for express-boilerplate';
  const templateData = { email, otp };
  try {
    await sendEmailWithTemplate(email, subject, templateName, templateData);
    const duration = Date.now() - start;
    await processEmailMetrics('success', duration);
    return 'success';
  } catch (e) {
    const duration = Date.now() - start;
    await processEmailMetrics('failure', duration);
    throw e;
  }
};
```

### The package exports the following utilities and helpers:

- `createApp`: Function to create a configured Express application instance
- `createRouter`: Function to create an Express router instance
- `wrapAsync`: Utility for handling async route handlers
- `ApiError`: Custom error class for API errors
- `errorMiddleware`: Error handling middleware
- `logger`: Winston logger instance
- `httpStatus`: HTTP status code constants
- `apiClient`: HTTP client utility
- `moment`: Date and time utility library
- `getClientIp`: Utility to extract the client's IP address from a request
- `getMetricsRegistry`: Returns the Prometheus metrics registry instance for custom metrics
- `promClient`: Prometheus client library for creating custom metrics
- `_`: Lodash utility library for functional programming helpers
